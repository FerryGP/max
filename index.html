<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>å’’è¯­é­”ç›’ (Prompt Fill Tool) V0.9.0</title>
<style>
    /* --- æ ¸å¿ƒä¸»é¢˜å˜é‡ (å¤åˆ»åŸç«™é…è‰²) --- */
    :root {
        /* åŸç«™æ ‡å¿—æ€§ç´«è‰² */
        --primary: #6366f1; 
        /* é€‰ä¸­æ€çš„æ·¡ç´«è‰²èƒŒæ™¯ */
        --primary-light: #eef2ff; 
        --text-main: #1f2937;
        --text-sub: #6b7280;
        /* èƒŒæ™¯åç™½ç° */
        --bg-body: #f8fafc; 
        --bg-white: #ffffff;
        --border: #e2e8f0;
        --radius: 12px;
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
        
        /* å˜é‡åˆ†ç»„è‰²ç³» (å¤åˆ»æˆªå›¾) */
        --c-char-bg: #dbeafe; --c-char-text: #1d4ed8; /* è“ */
        --c-act-bg: #fce7f3; --c-act-text: #be185d;  /* ç²‰ */
        --c-vis-bg: #f3e8ff; --c-vis-text: #7e22ce;  /* ç´« */
        --c-item-bg: #ffedd5; --c-item-text: #c2410c; /* æ©™ */
        --c-loc-bg: #d1fae5; --c-loc-text: #047857;  /* ç»¿ */
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body { 
        margin: 0; 
        font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; 
        background: var(--bg-body); 
        color: var(--text-main); 
        height: 100dvh; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden; 
    }

    /* --- å¸ƒå±€å®¹å™¨ --- */
    .app-viewport { flex: 1; overflow: hidden; position: relative; width: 100%; height: 100%; }
    
    .tab-view { 
        position: absolute; inset: 0; display: none; flex-direction: column; 
        background: var(--bg-body); 
        padding-bottom: calc(56px + var(--safe-bottom)); 
    }
    .tab-view.active { display: flex; animation: fadeIn 0.2s ease-out; }
    
    .scroll-content { 
        flex: 1; 
        overflow-y: auto; 
        overflow-x: hidden; 
        -webkit-overflow-scrolling: touch; 
        padding: 16px; 
    }

    /* --- é¡¶éƒ¨æ ‡é¢˜æ  --- */
    .header-bar { 
        padding: 12px 20px; 
        padding-top: calc(12px + var(--safe-top));
        background: var(--bg-body); /* æ¨¡ç‰ˆé¡µèƒŒæ™¯é€šé€ */
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        z-index: 20; 
        min-height: calc(56px + var(--safe-top)); 
    }
    /* Editor é¡µéœ€è¦ç™½è‰²èƒŒæ™¯ */
    #tab-editor .header-bar, #tab-config .header-bar { background: var(--bg-white); border-bottom: 1px solid var(--border); }

    .page-title { font-size: 18px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
    .version-tag { font-size: 10px; color: #9ca3af; font-weight: 400; border: 1px solid #e5e7eb; padding: 1px 4px; border-radius: 4px; }
    
    .btn-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: var(--text-sub); transition: 0.1s; background: transparent; border: none; }
    .btn-icon:active { background: #f3f4f6; color: var(--text-main); }
    .btn-icon.primary { background: #eef2ff; color: var(--primary); }

    /* --- Editor äº¤äº’å¼é¢„è§ˆ --- */
    .editor-card { background: var(--bg-white); border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; min-height: 200px; border: 1px solid var(--border); }
    
    /* å›¾ç‰‡å ä½åŒº (å¤åˆ») */
    .card-visual { height: 180px; background: linear-gradient(180deg, #eef2ff 0%, #ffffff 100%); display: flex; align-items: center; justify-content: center; position: relative; border-bottom: 1px solid #f1f5f9; }
    .card-visual svg { opacity: 0.5; color: var(--primary); }
    
    .card-content { padding: 24px 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 15px; line-height: 1.8; color: #374151; white-space: pre-wrap; flex: 1; }
    
    /* äº¤äº’å¼èƒ¶å›Š (Chips) */
    .interactive-chip { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 6px; font-size: 13px; font-weight: 600; margin: 0 2px; cursor: pointer; transition: all 0.1s; border: 1px solid transparent; white-space: nowrap; user-select: none; vertical-align: middle; }
    .interactive-chip:active { transform: scale(0.96); opacity: 0.9; }
    .interactive-chip.empty { border-style: dashed; background: #fff; color: #9ca3af; border-color: #cbd5e1; }

    /* åˆ†ç»„é¢œè‰²åº”ç”¨ */
    .chip-char { background: var(--c-char-bg); color: var(--c-char-text); }
    .chip-act { background: var(--c-act-bg); color: var(--c-act-text); }
    .chip-vis { background: var(--c-vis-bg); color: var(--c-vis-text); }
    .chip-item { background: var(--c-item-bg); color: var(--c-item-text); }
    .chip-loc { background: var(--c-loc-bg); color: var(--c-loc-text); }
    
    /* --- åº•éƒ¨é€‰è¯é¢æ¿ (Bottom Sheet) --- */
    .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s; display: flex; flex-direction: column; justify-content: flex-end; backdrop-filter: blur(2px); }
    .sheet-overlay.open { opacity: 1; pointer-events: auto; }
    
    .sheet-container { background: var(--bg-white); width: 100%; max-height: 60vh; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.25s cubic-bezier(0.32, 0.72, 0, 1); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); }
    .sheet-overlay.open .sheet-container { transform: translateY(0); }
    
    .sheet-header { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .sheet-label { font-size: 15px; font-weight: 700; color: var(--text-main); }
    .sheet-tag { font-size: 10px; font-weight: 600; color: #fff; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
    
    .sheet-body { overflow-y: auto; padding: 0; flex: 1; background: #fff; }
    .sheet-opt { padding: 14px 20px; font-size: 14px; color: #374151; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f8fafc; transition: 0.1s; }
    .sheet-opt:active { background: #f1f5f9; }
    /* å¤åˆ»æˆªå›¾é€‰ä¸­æ€ */
    .sheet-opt.selected { color: var(--primary); font-weight: 600; background: #f8faff; }
    .sheet-opt-check { opacity: 0; color: var(--primary); font-weight: bold; }
    .sheet-opt.selected .sheet-opt-check { opacity: 1; }
    
    .sheet-footer { padding: 12px 20px calc(12px + var(--safe-bottom)); border-top: 1px solid #f1f5f9; background: #fff; }
    .btn-add-custom { width: 100%; padding: 12px; border: 1px dashed #cbd5e1; border-radius: 10px; color: var(--text-sub); font-size: 13px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; background: transparent; }

    /* --- æ¨¡ç‰ˆåˆ—è¡¨ (å®Œå…¨å¤åˆ» IMG_2943 / IMG_2944) --- */
    /* ç§»é™¤å›¾æ ‡ï¼Œçº¯æ–‡å­—ï¼Œé€‰ä¸­å·¦ä¾§æœ‰ç«–æ¡ */
    .tpl-item { 
        background: transparent; 
        padding: 16px 12px; 
        margin-bottom: 4px; 
        display: flex; 
        flex-direction: column;
        border-radius: 8px; 
        position: relative;
        transition: 0.15s;
    }
    .tpl-item:active { background: rgba(0,0,0,0.03); }
    
    /* é€‰ä¸­æ€ï¼šç™½è‰²å¡ç‰‡+é˜´å½±+å·¦ä¾§ç´«æ¡ */
    .tpl-item.active { 
        background: #fff; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        padding-left: 16px; /* å¢åŠ å†…è¾¹è·ç»™ç«–æ¡ */
    }
    .tpl-item.active::before { 
        content: ""; 
        position: absolute; 
        left: 0; 
        top: 12px; 
        bottom: 12px; 
        width: 4px; 
        background: var(--primary); 
        border-radius: 0 4px 4px 0; 
    }
    
    .tpl-row-main { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .tpl-name { font-size: 15px; font-weight: 500; color: var(--text-main); }
    .tpl-actions { display: none; gap: 12px; align-items: center; }
    
    /* é€‰ä¸­æ—¶æ˜¾ç¤ºæ“ä½œå›¾æ ‡ */
    .tpl-item.active .tpl-actions { display: flex; }
    .action-icon { color: #9ca3af; padding: 4px; }
    .action-icon:active { color: var(--primary); }

    /* åº•éƒ¨æ–°å»ºæŒ‰é’® (Block Button) */
    .bottom-action-area { 
        position: absolute; 
        bottom: calc(56px + var(--safe-bottom)); 
        left: 0; right: 0; 
        padding: 16px 20px; 
        background: linear-gradient(to top, var(--bg-body) 80%, rgba(243,244,246,0)); 
        z-index: 10;
    }
    .btn-create-block { 
        width: 100%; 
        height: 48px; 
        background: var(--primary); 
        color: white; 
        border-radius: 10px; 
        font-weight: 600; 
        font-size: 15px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 6px; 
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    .btn-create-block:active { transform: scale(0.98); }

    /* --- è¯åº“é…ç½® --- */
    .conf-group { margin-bottom: 24px; }
    .conf-title { padding: 0 8px 8px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px; }
    .conf-list { background: #fff; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
    .conf-row { padding: 16px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
    .conf-row:last-child { border-bottom: none; }
    .conf-key { font-family: monospace; font-size: 11px; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }

    /* --- åº•éƒ¨å¯¼èˆª --- */
    .bottom-nav { height: calc(56px + var(--safe-bottom)); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #e5e7eb; position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; padding-bottom: var(--safe-bottom); z-index: 50; }
    .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; color: #9ca3af; font-size: 10px; font-weight: 500; height: 100%; transition: 0.1s; }
    .nav-btn.active { color: var(--primary); }
    .nav-btn svg { width: 22px; height: 22px; transition: transform 0.2s; }
    .nav-btn.active svg { transform: translateY(-2px); }

    /* æµ®åŠ¨å¤åˆ¶æŒ‰é’® (Editoré¡µ) */
    .fab-copy { position: fixed; bottom: calc(70px + var(--safe-bottom)); right: 20px; width: 48px; height: 48px; border-radius: 24px; background: #1f2937; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 40; transition: 0.2s; }
    .fab-copy:active { transform: scale(0.9); }

    /* åŠ¨ç”» */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
<!-- HTML2Canvas -->
<script src="https://cdn.staticfile.net/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<div class="app-viewport">

    <!-- TAB 1: æ¨¡ç‰ˆç®¡ç† (å®Œå…¨å¤åˆ» IMG_2943) -->
    <div id="tab-templates" class="tab-view active">
        <div class="header-bar">
            <div class="page-title">
                æç¤ºè¯å¡«ç©ºå™¨ <span class="version-tag">V0.9.0</span>
            </div>
            <div style="font-size:12px;color:#6b7280;background:#f3f4f6;padding:2px 8px;border-radius:12px;">CN</div>
        </div>
        
        <div style="padding: 0 20px; margin-bottom: 10px; display:flex; align-items:center; gap:8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2" style="background:#eef2ff; border-radius:6px; padding:2px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            <div style="font-weight:700; font-size:15px;">æ¨¡ç‰ˆç®¡ç†</div>
        </div>
        <div style="padding: 0 20px; font-size:12px; color:#9ca3af; margin-bottom:10px;">åˆ‡æ¢æˆ–ç®¡ç†ä¸åŒ Prompt</div>

        <div id="tpl-list" class="scroll-content" style="padding-bottom: 100px;">
            <!-- JS ç”Ÿæˆ -->
        </div>
        
        <!-- åº•éƒ¨æ–°å»ºæŒ‰é’® (å¤åˆ» IMG_2944) -->
        <div class="bottom-action-area">
            <button class="btn-create-block" onclick="createNewTemplate()">
                <span>+</span> æ–°å»ºæ¨¡ç‰ˆ
            </button>
        </div>
    </div>

    <!-- TAB 2: Editor (äº¤äº’å¼å¡«ç©º) -->
    <div id="tab-editor" class="tab-view">
        <div class="header-bar">
            <div class="page-title" id="editor-title" style="font-size:16px;max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">æœªé€‰æ‹©æ¨¡ç‰ˆ</div>
            <div style="display:flex;gap:4px;">
                <button class="btn-icon" onclick="switchMode()" title="åˆ‡æ¢æ¨¡å¼">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                </button>
                <button class="btn-icon" onclick="exportImage()" title="ä¿å­˜å›¾ç‰‡">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                </button>
                <button class="btn-icon primary" onclick="copyResult()" title="å¤åˆ¶">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                </button>
            </div>
        </div>

        <div class="scroll-content" style="background: #f8fafc; padding: 16px;">
            <!-- å¡«ç©ºæ¨¡å¼ (äº¤äº’å¼å¡ç‰‡) -->
            <div id="editor-fill-mode" class="editor-card">
                <div class="card-visual">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                </div>
                <div style="padding: 16px 20px 0;">
                    <div style="display:inline-block; font-size:10px; font-weight:700; color:var(--primary); background:#eef2ff; padding:2px 6px; border-radius:4px;">Prompt Template</div>
                    <div style="font-size:10px; color:#9ca3af; margin-top:4px;">Made by "å’’è¯­é­”ç›’"</div>
                </div>
                <div id="editor-interactive-area" class="card-content">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æºç æ¨¡å¼ -->
            <div id="editor-code-mode" style="display:none; height:100%; flex-direction:column; gap:12px;">
                <input id="code-title" placeholder="æ¨¡ç‰ˆæ ‡é¢˜" style="padding:16px;border:1px solid #e2e8f0;border-radius:12px;font-size:15px;font-weight:600;">
                <textarea id="code-content" style="flex:1;padding:16px;border:1px solid #e2e8f0;border-radius:12px;resize:none;font-family:monospace;line-height:1.6;font-size:14px;" placeholder="è¾“å…¥ Prompt..."></textarea>
            </div>
        </div>
        
        <!-- æ‚¬æµ®å¤åˆ¶æŒ‰é’® -->
        <div class="fab-copy" onclick="copyResult()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        </div>
    </div>

    <!-- TAB 3: è¯åº“é…ç½® -->
    <div id="tab-config" class="tab-view">
        <div class="header-bar">
            <div class="page-title">è¯åº“é…ç½®</div>
            <div style="font-size:12px;padding:4px 10px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;color:#6b7280;">ç®¡ç†åˆ†ç±»</div>
        </div>
        <div style="padding:0 20px;font-size:12px;color:#9ca3af;">æ‰€æœ‰æ¨¡ç‰ˆå…±äº«åŒä¸€å¥—è¯åº“</div>
        <div id="config-list" class="scroll-content">
            <!-- JS ç”Ÿæˆ -->
        </div>
    </div>

</div>

<!-- åº•éƒ¨é€‰è¯é¢æ¿ (å¤åˆ» IMG_2948) -->
<div id="bottom-sheet" class="sheet-overlay" onclick="closeSheet(event)">
    <div class="sheet-container" onclick="event.stopPropagation()">
        <div class="sheet-header">
            <div style="display:flex;align-items:center;gap:10px;">
                <span style="font-size:13px;color:#6b7280;">é€‰æ‹©</span>
                <span class="sheet-label" id="sheet-label">å˜é‡å</span>
            </div>
            <span class="sheet-tag" id="sheet-group-tag" style="background:#999;">GROUP</span>
        </div>
        <div class="sheet-body" id="sheet-options">
            <!-- é€‰é¡¹åˆ—è¡¨ -->
        </div>
        <div class="sheet-footer">
            <button class="btn-add-custom" onclick="addCustomOption()">
                <span style="font-size:16px;">+</span> æ·»åŠ è‡ªå®šä¹‰é€‰é¡¹
            </button>
        </div>
    </div>
</div>

<!-- åº•éƒ¨å¯¼èˆªæ  -->
<div class="bottom-nav">
    <div class="nav-btn active" onclick="switchTab('templates')" id="nav-templates">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        <span>æ¨¡ç‰ˆç®¡ç†</span>
    </div>
    <div class="nav-btn" onclick="switchTab('config')" id="nav-config">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        <span>è¯åº“é…ç½®</span>
    </div>
    <div class="nav-btn" onclick="switchTab('editor')" id="nav-editor">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        <span>Editor</span>
    </div>
</div>

<script>
// --- 1. æ•°æ®é…ç½® (å…¨é‡åŒæ­¥) ---
const VAR_MAP = {
    role: "è§’è‰²èº«ä»½", subject: "ä¸»ä½“å¯¹è±¡", character_companion: "åˆå½±è§’è‰²", expressions: "è¡¨æƒ…é›†",
    grid_pose: "ä¹å®«æ ¼åŠ¨ä½œ", action_detail: "åŠ¨ä½œç»†èŠ‚", action_pose: "äº’åŠ¨å§¿åŠ¿",
    layout_focus: "æ„å›¾é‡å¿ƒ", camera_angle: "æ‹æ‘„è§’åº¦", connectors: "è§†è§‰å¼•å¯¼", texture_zoom: "æè´¨ç‰¹å†™",
    special_view: "ç‰¹æ®Šè§†è§’", art_style: "ç”»é£", background_style: "èƒŒæ™¯é£æ ¼", lens_param: "ä¹å®«æ ¼é•œå¤´", lighting: "ç¯å…‰å¸ƒç½®",
    underwear_style: "ç§å¯†å†…ç€æ‹†è§£", clothing: "äººç‰©æœé¥°", clothing_male: "ç”·æ€§æœé¥°", clothing_female: "å¥³æ€§æœé¥°",
    bag_content: "éšèº«åŒ…è¢‹", cosmetics: "ç¾å¦†ä¸æŠ¤ç†", private_items: "ç§å¯†ç”Ÿæ´»ç‰©ä»¶", fashion_deconstruct: "ç©¿æ­è§£æ„",
    toy_companion: "äº’åŠ¨å…¬ä»”", sticker_core: "æ ¸å¿ƒè´´çº¸", sticker_decor: "è£…é¥°å…ƒç´ ",
    background_scene: "èƒŒæ™¯åœºæ™¯"
};

const VAR_GROUPS = {
    character: { label: "äººç‰© (CHARACTER)", keys: ["role", "subject", "character_companion", "expressions"], color: "#3b82f6", bg: "#dbeafe", text: "#1e40af" },
    action: { label: "åŠ¨ä½œ (ACTION)", keys: ["grid_pose", "action_detail", "action_pose"], color: "#ec4899", bg: "#fce7f3", text: "#db2777" },
    visuals: { label: "ç”»é¢ (VISUALS)", keys: ["layout_focus", "camera_angle", "connectors", "texture_zoom", "special_view", "art_style", "background_style", "lens_param", "lighting"], color: "#8b5cf6", bg: "#f3e8ff", text: "#7e22ce" },
    item: { label: "ç‰©å“ (ITEM)", keys: ["underwear_style", "clothing", "clothing_male", "clothing_female", "bag_content", "cosmetics", "private_items", "fashion_deconstruct", "toy_companion", "sticker_core", "sticker_decor"], color: "#f59e0b", bg: "#ffedd5", text: "#c2410c" },
    location: { label: "åœ°ç‚¹ (LOCATION)", keys: ["background_scene"], color: "#10b981", bg: "#d1fae5", text: "#047857" }
};

const DEFAULT_OPTIONS = {
    role: ["æ¸¸æˆä¸åŠ¨æ¼«æ¦‚å¿µç¾æœ¯è®¾è®¡å¤§å¸ˆ", "èµ„æ·±æ—¶å°šæ‘„å½±å¸ˆ", "ç”µå½±åˆ†é•œå¸ˆ", "äººè®¾ç”»å¸ˆ"],
    subject: ["å¥³æ€§è§’è‰²", "èµ›åšæœ‹å…‹é»‘å®¢", "å¥‡å¹»ç²¾çµæ¸¸ä¾ ", "ç°ä»£éƒ½å¸‚ç™½é¢†", "æœºç”²é©¾é©¶å‘˜", "å…‹è‹é²ä¿®å¥³"],
    character_companion: ["ä¸€åªè‚¥çŒ«", "ç«¥å¹´çš„è‡ªå·±", "å®¿æ•Œ", "å…¨æ¯æŠ•å½±AI", "æ­»ä¾", "è¶…äºº"],
    expressions: ["ç–¯ç‹‚ã€ç—…å¨‡ã€ç‹‚å–œ", "å†·æ¼ ã€è½»è”‘ã€æ— è§†", "ç¾æ¶©ã€è„¸çº¢ã€èº²é—ª", "è‡ªä¿¡ã€å¼ æ‰¬ã€å¤§ç¬‘"],
    grid_pose: ["ç«™ç«‹ã€åå§¿ã€åŠ¨æ€è·‘è·³", "æˆ˜æ–—å§¿æ€å±•ç¤º", "æ—¥å¸¸ä¼‘é—²åŠ¨ä½œ", "æ–½æ³•åŠ¨ä½œåˆ†è§£"],
    action_detail: ["å¸¦ç€é¡¹åœˆçš„çˆ¬è¡Œ", "æ‹”å‰‘æˆ˜æ–—å§¿æ€", "ä¼˜é›…çš„ä¸‹åˆèŒ¶æ—¶å…‰", "æ•´ç†é¢†å¸¦", "æ“¦æ‹­çœ¼é•œ"],
    action_pose: ["èƒŒé èƒŒæˆ˜æ–—", "äº’ç›¸å–‚é£Ÿ", "æ‘¸å¤´æ€", "å¯¹å³™", "å‹¾è‚©æ­èƒŒæ¯”Vå­—æ‰‹åŠ¿", "å£å’š"],
    layout_focus: ["å…¨èº«ç«‹ç»˜", "åŠèº«åƒ", "ç‰¹å†™é•œå¤´", "èƒŒå½±", "ä¾§é¢œ"],
    camera_angle: ["å¹³è§†", "ä½è§’åº¦ä»°è§†", "é«˜è§’åº¦ä¿¯è§†", "è·å…°è§’å€¾æ–œ", "é±¼çœ¼å¤¸å¼ "],
    connectors: ["æ‰‹ç»˜ç®­å¤´æˆ–å¼•å¯¼çº¿", "è™šçº¿è¿æ¥", "å…‰æ•ˆæŒ‡å¼•", "æœºæ¢°è‡‚è¿æ¥", "è—¤è”“ç¼ ç»•"],
    texture_zoom: ["å‡Œä¹±æ„Ÿä¸ç§å¤„æ±—æ¸", "çš®é©çº¹ç†ä¸ç£¨æŸ", "é‡‘å±å…‰æ³½ä¸é”ˆè¿¹", "ä¸ç»¸å…‰æ³½", "çš®è‚¤æ¯›å­”"],
    special_view: ["è¢«è¸©åœ¨è„šä¸‹çš„ä»°è§†è§†è§’", "ä¸Šå¸è§†è§’ä¿¯ç°", "é±¼çœ¼é•œå¤´ç‰¹å†™", "ç›‘æ§æ‘„åƒå¤´è§†è§’", "ç¬¬ä¸€äººç§°è§†è§’"],
    art_style: ["é«˜è´¨é‡çš„2D æ’ç”»é£æ ¼", "å‰åœåŠ›åŠ¨ç”»é£æ ¼", "åšæ¶‚æ²¹ç”»é£æ ¼", "èµ›åšæœ‹å…‹éœ“è™¹é£æ ¼", "é»‘ç™½æ¼«ç”»é£æ ¼", "åƒç´ è‰ºæœ¯"],
    background_style: ["æ¼«ç”»ç½‘æ ¼ç¬”è®°æœ¬", "çº¯è‰²æç®€èƒŒæ™¯", "èµ›åšæœ‹å…‹éœ“è™¹è¡—é“", "åºŸå¼ƒå·¥å‚å†…éƒ¨", "é­”æ³•é˜µ"],
    lens_param: ["85mm äººåƒé•œå¤´", "35mm äººæ–‡å¹¿è§’", "200mm é•¿ç„¦å‹ç¼©", "å¾®è·é•œå¤´"],
    lighting: ["è‡ªç„¶å…‰", "èµ›åšéœ“è™¹å…‰", "ä¼¦å‹ƒæœ—å…‰", "è¾¹ç¼˜å…‰(Rim Light)", "é¡¶å…‰", "ä¸è¾¾å°”æ•ˆåº”"],
    underwear_style: ["æˆå¥—çš„è•¾ä¸å†…è¡£è£¤", "è¿åŠ¨å†…è¡£", "æ£‰è´¨ç®€çº¦æ¬¾", "ç»‘å¸¦é£æ ¼", "æ¯”åŸºå°¼"],
    clothing: ["æœºèƒ½é£å¤–å¥—", "ä¸ç»¸é•¿è£™", "æˆ˜æ–—è£…ç”²", "JKåˆ¶æœ", "æ——è¢", "å¥³ä»†è£…"],
    clothing_male: ["è¥¿è£…", "å«è¡£", "æˆ˜æœ¯èƒŒå¿ƒ", "å¤é£é•¿è¢"],
    clothing_female: ["è¿è¡£è£™", "çŸ­è£™", "ç´§èº«è¡£", "æ™šç¤¼æœ"],
    bag_content: ["æ—¥å¸¸é€šå‹¤åŒ…æˆ–æ‰‹æ‹¿åŒ…", "æˆ˜æœ¯èƒŒåŒ…", "é­”æ³•è¯å‰‚è¢‹", "æ•£è½çš„å£çº¢ä¸æ‰‹æœº", "ä¸€å †é›¶é£Ÿ"],
    cosmetics: ["å¸¸ç”¨çš„åŒ–å¦†å“ç»„åˆ", "æˆ˜åœ°æ€¥æ•‘åŒ…", "é­”æ³•ç¬¦æ–‡ç»˜åˆ¶å·¥å…·", "æ˜“å®¹å·¥å…·"],
    private_items: ["éœ‡åŠ¨æ£’ä¸é¡¹åœˆ", "æ—¥è®°æœ¬ä¸æ—§ç…§ç‰‡", "æŠ¤èº«ç¬¦ä¸æ°´æ™¶", "æ‰‹é“ä¸é’¥åŒ™", "ä¸€å°æƒ…ä¹¦"],
    fashion_deconstruct: ["é¢æ–™è‰²å¡", "è®¾è®¡è‰å›¾", "ç‰ˆå‹æ‹†è§£", "é…é¥°ç»†èŠ‚"],
    toy_companion: ["æ³°è¿ªç†Š", "æœºæ¢°ç‹—", "å·«æ¯’å¨ƒå¨ƒ", "ç²˜åœŸäºº"],
    sticker_core: ["çˆ±å¿ƒè´´çº¸", "åˆ›å¯è´´", "è­¦å‘Šæ ‡è¯†", "æ¡å½¢ç "],
    sticker_decor: ["æ˜Ÿæ˜Ÿ", "èŠ±ç“£", "è¡€è¿¹", "éŸ³ç¬¦"],
    background_scene: ["å……æ»¡ç”Ÿæ´»æ°”æ¯çš„å§å®¤", "ä¸‹é›¨çš„è¡—é“", "é­”æ³•å­¦é™¢å›¾ä¹¦é¦†", "å¤ªç©ºèˆ±", "å¤–å¤ªç©ºé£èˆ¹å†…éƒ¨", "æœ«æ—¥åºŸå¢Ÿ"]
};

const DEFAULT_TEMPLATES = [
    { 
        id: 't1', title: 'è§’è‰²æ¦‚å¿µåˆ†è§£å›¾', 
        content: `Role (è§’è‰²è®¾å®š)\nä½ æ˜¯ä¸€ä½é¡¶å°–çš„ {{role}} ï¼Œæ“…é•¿åˆ¶ä½œè¯¦å°½çš„è§’è‰²è®¾å®šå›¾ï¼ˆCharacter Sheetï¼‰ã€‚ä½ å…·å¤‡â€œåƒç´ çº§æ‹†è§£â€çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿé€è§†è§’è‰²çš„ç©¿ç€å±‚çº§ã€æ•æ‰å¾®è¡¨æƒ…å˜åŒ–ï¼Œå¹¶å°†ä¸å…¶ç›¸å…³çš„ç‰©å“è¿›è¡Œå…·è±¡åŒ–è¿˜åŸã€‚ä½ ç‰¹åˆ«æ“…é•¿é€šè¿‡ {{subject}} çš„ç§å¯†ç‰©å“ã€éšèº«ç‰©ä»¶å’Œç”Ÿæ´»ç»†èŠ‚æ¥ä¾§é¢ä¸°æ»¡äººç‰©æ€§æ ¼ä¸èƒŒæ™¯æ•…äº‹ã€‚\n\nTask (ä»»åŠ¡ç›®æ ‡)\næ ¹æ®ç”¨æˆ·ä¸Šä¼ æˆ–æè¿°çš„ä¸»ä½“å½¢è±¡ï¼Œç”Ÿæˆä¸€å¼ â€œå…¨æ™¯å¼è§’è‰²æ·±åº¦æ¦‚å¿µåˆ†è§£å›¾â€ã€‚è¯¥å›¾ç‰‡å¿…é¡»åŒ…å« {{layout_focus}} ï¼Œå¹¶åœ¨å…¶å‘¨å›´ç¯ç»•å±•ç¤ºè¯¥äººç‰©çš„æœè£…åˆ†å±‚ã€ä¸åŒè¡¨æƒ…ã€æ ¸å¿ƒé“å…·ã€æè´¨ç‰¹å†™ï¼Œä»¥åŠæå…·ç”Ÿæ´»æ°”æ¯çš„ç§å¯†ä¸éšèº«ç‰©å“å±•ç¤ºã€‚\n\nVisual Guidelines (è§†è§‰è§„èŒƒ)\n1. æ„å›¾å¸ƒå±€(Layout):\nâ€¢ä¸­å¿ƒä½(Center): æ”¾ç½®è§’è‰²çš„ {{layout_focus}} ï¼Œä½œä¸ºè§†è§‰é”šç‚¹ã€‚\nâ€¢ç¯ç»•ä½(Surroundings): åœ¨ä¸­å¿ƒäººç‰©å››å‘¨ç©ºç™½å¤„ï¼Œæœ‰åºæ’åˆ—æ‹†è§£åçš„å…ƒç´ ã€‚\nâ€¢è§†è§‰å¼•å¯¼(Connectors): ä½¿ç”¨ {{connectors}} ï¼Œå°†å‘¨è¾¹çš„æ‹†è§£ç‰©å“ä¸ä¸­å¿ƒäººç‰©çš„å¯¹åº”éƒ¨ä½æˆ–æ‰€å±åŒºåŸŸè¿æ¥èµ·æ¥ã€‚\n\n2. æ‹†è§£å†…å®¹(Deconstruction Details):\nâ€¢æœè£…åˆ†å±‚(Clothing Layers): å°†è§’è‰²çš„æœè£…æ‹†åˆ†ä¸ºå•å“å±•ç¤ºï¼Œä¾‹å¦‚ï¼š {{clothing}}\nâ€¢ç§å¯†å†…ç€æ‹†è§£: ç‹¬ç«‹å±•ç¤ºè§’è‰²çš„å†…å±‚è¡£ç‰©ï¼Œé‡ç‚¹çªå‡ºè®¾è®¡æ„Ÿä¸æè´¨ã€‚ä¾‹å¦‚ï¼š {{underwear_style}} ï¼ˆå±•ç¤ºç»†èŠ‚ä¸å‰ªè£ï¼‰ã€‚\nâ€¢è¡¨æƒ…é›†(Expression Sheet): åœ¨è§’è½ç»˜åˆ¶3-4 ä¸ªä¸åŒçš„å¤´éƒ¨ç‰¹å†™ï¼Œå±•ç¤ºä¸åŒçš„æƒ…ç»ªï¼Œå¦‚ï¼š {{expressions}} ã€‚\nâ€¢æè´¨ç‰¹å†™(Texture & Zoom): é€‰å–å…³é”®éƒ¨ä½è¿›è¡Œæ”¾å¤§ç‰¹å†™ã€‚ä¾‹å¦‚ï¼š {{texture_zoom}} ï¼Œå¢åŠ å¯¹å°ç‰©ä»¶æè´¨çš„æç»˜ã€‚\nâ€¢åŠ¨ä½œ: ç»˜åˆ¶ç‰¹æ®Šçš„åŠ¨ä½œå’Œè¡¨æƒ…ï¼Œä¾‹å¦‚ï¼š {{action_detail}} ï¼Œå¢åŠ åŠ¨ä½œçš„æ·±åº¦åˆ»ç”»ã€‚\nâ€¢ç‰¹æ®Šè§†è§’: ç»˜åˆ¶ä»æŸç§ç‰¹æ®Šåœºæ™¯ä¸‹æ‹æ‘„çš„ç‰¹æ®Šè§†è§’ï¼Œä¾‹å¦‚ï¼š {{special_view}}\nâ€¢å…³è”ç‰©å“(Related Items):\nâ€¢éšèº«åŒ…è¢‹ä¸å†…å®¹ç‰©: ç»˜åˆ¶ {{bag_content}} ï¼Œå¹¶å°†å…¶â€œæ‰“å¼€â€ï¼Œå±•ç¤ºæ•£è½åœ¨æ—çš„ç‰©å“ã€‚\nâ€¢ç¾å¦†ä¸æŠ¤ç†: å±•ç¤º {{cosmetics}} ã€‚\nâ€¢ç§å¯†ç”Ÿæ´»ç‰©ä»¶: å…·è±¡åŒ–è§’è‰²éšè—é¢çš„ç‰©å“ã€‚æ ¹æ®è§’è‰²æ€§æ ¼å¯èƒ½åŒ…æ‹¬ï¼š {{private_items}} ï¼Œéœ€ä»¥ä¸€ç§è®¾è®¡å›¾çš„å®¢è§‚è§†è§’å‘ˆç°ã€‚\n\n3. é£æ ¼ä¸æ³¨é‡Š(Style & Annotations):\nâ€¢ç”»é£: {{art_style}} ï¼Œçº¿æ¡å¹²å‡€åˆ©è½ã€‚\nâ€¢èƒŒæ™¯: {{background_style}} ï¼Œè¥é€ è®¾è®¡æ‰‹ç¨¿çš„æ°›å›´ã€‚\nâ€¢ç¯å…‰: {{lighting}}` 
    },
    { 
        id: 't2', title: '3x3 æ‘„å½±ç½‘æ ¼', 
        content: `Create a 3x3 photography grid showing different angles and details of {{subject}}.\n\nSettings:\nâ€¢ Role: {{role}}\nâ€¢ Lens: {{lens_param}}\nâ€¢ Lighting: {{lighting}}\nâ€¢ Art Style: {{art_style}}\n\nGrid Content:\n1. Top Left: Close-up of face, {{expressions}}\n2. Top Center: Full body shot, {{grid_pose}}\n3. Top Right: Detail of {{clothing}}\n4. Center Left: Side profile\n5. Center: Main action shot, {{action_pose}}\n6. Center Right: Back view\n7. Bottom Left: Accessory detail, {{bag_content}}\n8. Bottom Center: Footwear/Shoes\n9. Bottom Right: Artistic blur or {{special_view}}` 
    },
    { id: 't3', title: 'æ—¶å°šæƒ…ç»ªæ¿æ’ç”»', content: `Create a Fashion Moodboard Illustration for {{subject}}.\n\nElements:\nâ€¢ Outfit: {{clothing}}\nâ€¢ Deconstruction: {{fashion_deconstruct}}\n\nStyle:\nâ€¢ Art: {{art_style}}\nâ€¢ Bg: {{background_style}}\nâ€¢ Items: {{bag_content}}` },
    { id: 't4', title: 'äººç‰©è¶£å‘³åˆå½±', content: `Character Selfie (äººç‰©è¶£å‘³åˆå½±)\n\nè®© {{character_companion}} ç«™åœ¨ {{subject}} æ—è¾¹ï¼Œ\n\n{{action_pose}} ï¼ŒåŒæ—¶å¯¹ç€é•œå¤´éœ²å‡º {{expressions}} çš„è¡¨æƒ…ã€‚\n\nèƒŒæ™¯ï¼šä»¥ {{background_scene}} ä¸ºèƒŒæ™¯ã€‚\n\nè¦æ±‚ï¼šä¿æŒè‡ªæ‹æ„å›¾ä¸å˜ï¼Œè®©ä¸¤ä¸ªè§’è‰²è‡ªç„¶åœ°èå…¥ç”»é¢ï¼Œå…‰å½±ç»Ÿä¸€ï¼Œäº’åŠ¨è‡ªç„¶ã€‚` }
];

// --- 2. çŠ¶æ€ç®¡ç† ---
let state = {
    templates: JSON.parse(localStorage.getItem('pf_v9_tpl')) || DEFAULT_TEMPLATES,
    options: JSON.parse(localStorage.getItem('pf_v9_opt')) || DEFAULT_OPTIONS,
    activeId: localStorage.getItem('pf_v9_id') || 't1',
    values: JSON.parse(localStorage.getItem('pf_v9_val')) || {},
    tab: 'templates',
    mode: 'fill',
    currentVar: null
};

// --- 3. æ ¸å¿ƒåŠŸèƒ½ ---
function save() {
    localStorage.setItem('pf_v9_tpl', JSON.stringify(state.templates));
    localStorage.setItem('pf_v9_opt', JSON.stringify(state.options));
    localStorage.setItem('pf_v9_id', state.activeId);
    localStorage.setItem('pf_v9_val', JSON.stringify(state.values));
    render();
}

function getActiveTpl() { return state.templates.find(t => t.id === state.activeId) || state.templates[0]; }

function getVarGroup(key) {
    for (const [k, cfg] of Object.entries(VAR_GROUPS)) {
        if (cfg.keys.includes(key)) return { ...cfg, id: k };
    }
    return { label: 'å…¶ä»– (OTHER)', color: '#9ca3af', bg: '#f3f4f6', text: '#4b5563', id: 'other' };
}

// æ ¸å¿ƒï¼šç”Ÿæˆäº¤äº’å¼HTML (Chips)
function genInteractiveHtml() {
    const tpl = getActiveTpl();
    if (!tpl) return "";
    let html = tpl.content;
    const parts = html.split(/(\{\{[^}]+\}\})/g);
    
    return parts.map(part => {
        if (part.startsWith('{{') && part.endsWith('}}')) {
            const key = part.slice(2, -2).trim();
            const val = state.values[key];
            const group = getVarGroup(key);
            const label = VAR_MAP[key] || key;
            const cls = val ? `chip-${group.id}` : 'empty';
            const display = val || label;
            
            return `<span class="interactive-chip ${cls}" onclick="openSheet('${key}')">${display}</span>`;
        }
        return `<span>${part}</span>`;
    }).join('');
}

function genPlainText() {
    let txt = getActiveTpl().content;
    const regex = /\{\{([^}]+)\}\}/g;
    let m;
    const vars = new Set();
    while((m = regex.exec(txt)) !== null) vars.add(m[1].trim());
    
    vars.forEach(v => {
        txt = txt.split(`{{${v}}}`).join(state.values[v] || `{{${v}}`);
    });
    return txt;
}

// --- 4. æ¸²æŸ“é€»è¾‘ ---
function render() {
    // Tab åˆ‡æ¢
    document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${state.tab}`).classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(`nav-${state.tab}`).classList.add('active');

    // Tab 1: æ¨¡ç‰ˆåˆ—è¡¨ (å¤åˆ» IMG_2944)
    document.getElementById('tpl-list').innerHTML = state.templates.map(t => `
        <div class="tpl-item ${t.id === state.activeId ? 'active' : ''}" onclick="selectTemplate('${t.id}')">
            <div class="tpl-row-main">
                <div class="tpl-name">${t.title}</div>
            </div>
            <div class="tpl-actions">
                <div class="action-icon" onclick="switchMode();selectTemplate('${t.id}');event.stopPropagation()">âœ</div>
                <div class="action-icon" onclick="copyTemplate('${t.id}', event)">â</div>
                <div class="action-icon" style="color:#ef4444" onclick="deleteTemplate('${t.id}', event)">ğŸ—‘</div>
            </div>
        </div>
    `).join('');

    // Tab 2: Editor
    const tpl = getActiveTpl();
    document.getElementById('editor-title').innerText = tpl.title;
    
    if (state.mode === 'fill') {
        document.getElementById('editor-fill-mode').style.display = 'flex';
        document.getElementById('editor-code-mode').style.display = 'none';
        document.getElementById('editor-interactive-area').innerHTML = genInteractiveHtml();
    } else {
        document.getElementById('editor-fill-mode').style.display = 'none';
        document.getElementById('editor-code-mode').style.display = 'flex';
        document.getElementById('code-title').value = tpl.title;
        document.getElementById('code-content').value = tpl.content;
    }

    // Tab 3: Config (å¤åˆ» IMG_2945)
    const allVars = Object.keys(state.options);
    const groups = { other: [] };
    Object.keys(VAR_GROUPS).forEach(k => groups[k] = []);
    
    allVars.forEach(v => {
        let matched = false;
        for (const [k, cfg] of Object.entries(VAR_GROUPS)) { if(cfg.keys.includes(v)) { groups[k].push(v); matched=true; break; } }
        if (!matched) groups.other.push(v);
    });

    let confHtml = '';
    Object.entries(groups).forEach(([k, list]) => {
        if (list.length === 0) return;
        const cfg = VAR_GROUPS[k] || {label: 'å…¶ä»–', color: '#999'};
        confHtml += `<div class="conf-group"><div class="conf-title" style="color:${cfg.color}"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${cfg.color};margin-right:6px;"></span>${cfg.label}</div><div class="conf-list">`;
        list.forEach(v => {
            const label = VAR_MAP[v] || v;
            const count = (state.options[v]||[]).length;
            confHtml += `<div class="conf-row" onclick="openSheet('${v}')">
                <div><span>${label}</span><span class="conf-key">{{${v}}}</span></div>
                <div style="color:#9ca3af;font-size:12px;">${count} ></div>
            </div>`;
        });
        confHtml += `</div></div>`;
    });
    document.getElementById('config-list').innerHTML = confHtml;
}

// --- 5. äº¤äº’åŠ¨ä½œ ---
window.switchTab = (t) => { state.tab = t; save(); }
window.selectTemplate = (id) => { 
    state.activeId = id; 
    state.tab = 'editor'; 
    if(navigator.vibrate) navigator.vibrate(10);
    save(); 
}

window.switchMode = () => { 
    state.mode = state.mode === 'fill' ? 'code' : 'fill'; 
    save(); 
}

// åº•éƒ¨å¼¹çª—é€»è¾‘ (Sheet)
window.openSheet = (key) => {
    state.currentVar = key;
    const group = getVarGroup(key);
    const label = VAR_MAP[key] || key;
    
    document.getElementById('sheet-label').innerText = label;
    const tag = document.getElementById('sheet-group-tag');
    tag.innerText = group.label.split(' ')[0]; // åªæ˜¾ç¤ºä¸­æ–‡
    tag.style.background = group.color;
    
    const opts = state.options[key] || [];
    const currentVal = state.values[key];
    
    document.getElementById('sheet-options').innerHTML = opts.map(o => `
        <div class="sheet-opt ${o === currentVal ? 'selected' : ''}" onclick="selectOption('${o}')">
            <span>${o}</span>
            <span class="sheet-opt-check">âœ“</span>
        </div>
    `).join('') || '<div style="padding:20px;text-align:center;color:#ccc;">æš‚æ— é€‰é¡¹</div>';
    
    document.getElementById('bottom-sheet').classList.add('open');
}

window.closeSheet = (e) => {
    if(e && e.target !== document.getElementById('bottom-sheet') && !e.target.closest('button')) return;
    document.getElementById('bottom-sheet').classList.remove('open');
}

window.selectOption = (val) => {
    state.values[state.currentVar] = val;
    save();
    document.getElementById('bottom-sheet').classList.remove('open');
}

window.addCustomOption = () => {
    const val = prompt("è¾“å…¥æ–°é€‰é¡¹å†…å®¹:");
    if(val && val.trim()) {
        const key = state.currentVar;
        if(!state.options[key]) state.options[key] = [];
        state.options[key].push(val.trim());
        state.values[key] = val.trim(); // è‡ªåŠ¨é€‰ä¸­
        save();
        document.getElementById('bottom-sheet').classList.remove('open');
    }
}

// æ¨¡ç‰ˆæ–°å»º
window.createNewTemplate = () => {
    const id = 't'+Date.now();
    state.templates.push({id, title:'æ–°æ¨¡ç‰ˆ', content:'è¾“å…¥å†…å®¹ {{å˜é‡}}...'});
    state.activeId = id; state.tab = 'editor'; state.mode = 'code';
    save();
}

window.copyTemplate = (id, e) => {
    e.stopPropagation();
    const t = state.templates.find(x => x.id === id);
    state.templates.push({...t, id: 't'+Date.now(), title: t.title+'(å‰¯æœ¬)'});
    save();
}

window.deleteTemplate = (id, e) => {
    e.stopPropagation();
    if(state.templates.length <= 1) return alert('è‡³å°‘ä¿ç•™ä¸€ä¸ª');
    if(confirm('åˆ é™¤?')) {
        state.templates = state.templates.filter(x => x.id !== id);
        state.activeId = state.templates[0].id;
        save();
    }
}

// æºç ç¼–è¾‘ç›‘å¬
document.getElementById('code-title').addEventListener('input', e => {
    getActiveTpl().title = e.target.value;
});
document.getElementById('code-content').addEventListener('input', e => {
    getActiveTpl().content = e.target.value;
});
document.getElementById('code-content').addEventListener('blur', save);
document.getElementById('code-title').addEventListener('blur', save);

window.copyResult = () => navigator.clipboard.writeText(genPlainText()).then(()=>alert('å·²å¤åˆ¶'));
window.exportImage = () => {
    html2canvas(document.getElementById('editor-fill-mode')).then(c => {
        const a = document.createElement('a');
        a.download = 'prompt.png'; a.href = c.toDataURL(); a.click();
    });
}

// Init
render();
</script>
</body>
</html>